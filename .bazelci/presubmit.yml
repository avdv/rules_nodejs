---
bazel: 6.1.1
# Note, this will tell the user to do the wrong thing (manually run buildifer)
# See https://github.com/bazelbuild/continuous-integration/issues/1161
buildifier:
  version: 4.0.1
  # Keep this in sync with the list in .pre-commit-config.yaml
  # https://github.com/bazelbuild/buildtools/issues/479 should fix this by giving us a config file
  warnings: "-bzl-visibility,-function-docstring-args,-function-docstring-return,-print,-unnamed-macro,-provider-params,-function-docstring-header,-no-effect,-uninitialized,-rule-impl-return"
  # Note, we ought to be able to exclude third_party from this check, but currently cannot:
  # https://github.com/bazelbuild/continuous-integration/issues/1162
tasks:
  ubuntu1804:
    name: ubuntu1804
    platform: ubuntu1804
    run_targets:
    - "@yarn//:yarn"
    - "//internal/node/test:no_deps"
    - "//internal/node/test:has_deps_legacy"
    - "//internal/node/test:has_deps"
    - "//internal/node/test:has_deps_hybrid"
    - "//internal/npm_install/test:index"
    # Disabled due to https://github.com/bazelbuild/rules_nodejs/issues/1486
    #- "@fine_grained_deps_yarn//typescript/bin:tsc"
    build_targets:
    - "//..."
    test_flags:
    # Both chrome & firefox are missing shared libs on bazelci ubuntu.
    # On circleci we have the same issue but we can work around it using apt-get.
    # on bazelci apt-get fails with permission denied and there is no sudo
    # command to switch to root.
    # TODO(gregmagolan): figure out how to install missing shared libs
    - "--test_tag_filters=-browser:chromium-local,-browser:firefox-local,-browser:custom_chrome"
    test_targets:
    - "//..."
  # Temporarily disabled MacOS tests until pre-existing failure can be investigated.
  # macos:
  #   name: macos
  #   platform: macos
  #   run_targets:
  #   - "@yarn//:yarn"
  #   # Regression test for #1493
  #   - "//internal/node/test:no_deps"
  #   - "//internal/node/test:has_deps_legacy"
  #   - "//internal/node/test:has_deps"
  #   - "//internal/node/test:has_deps_hybrid"
  #   - "//internal/npm_install/test:index"
  #   # Disabled due to https://github.com/bazelbuild/rules_nodejs/issues/1486
  #   #- "@fine_grained_deps_yarn//typescript/bin:tsc"
  #   build_targets:
  #   - "//..."
  #   test_flags:
  #   # Firefox are missing shared libs on bazelci mac
  #   # TODO(gregmagolan): figure out how to install missing shared libs
  #   - "--test_tag_filters=-browser:firefox-local"
  #   test_targets:
  #   - "//..."
  # TODO(gregmagolan): fix platform configuraiton for this test job for Bazel 2.0
  # macos_fake_rbe:
  #   name: macos_fake_rbe
  #   platform: macos
  #   shell_commands:
  #   # Reproduce https://github.com/bazelbuild/rules_nodejs/issues/1305
  #   # TODO: switch to use real mac cross-platform RBE on CI when
  #   #       https://github.com/bazelbuild/continuous-integration/pull/749
  #   #       lands on bazelci master.
  #   - echo 'build --platforms=@rbe_default//config:platform' >> .bazelrc
  #   run_targets:
  #   - "//internal/node/test:no_deps"
  windows:
    name: windows
    platform: windows
    run_targets:
    - "@yarn//:yarn"
    - "//internal/node/test:no_deps"
    - "//internal/node/test:has_deps_legacy"
    - "//internal/node/test:has_deps"
    - "//internal/node/test:has_deps_hybrid"
    - "//internal/npm_install/test:index"
    # Disabled due to https://github.com/bazelbuild/rules_nodejs/issues/1486
    #- "@fine_grained_deps_yarn//typescript/bin:tsc"
    build_flags:
    - "--build_tag_filters=-fix-windows,-no-bazelci-windows,-requires-runfiles"
    build_targets:
    - "//..."
    test_flags:
    # Firefox not supported on Windows with rules_webtesting (if run it exit with success)
    # See https://github.com/bazelbuild/rules_webtesting/blob/0.3.3/browsers/BUILD.bazel#L66.
    - "--test_tag_filters=-fix-windows,-no-bazelci-windows,-requires-runfiles,-browser:firefox-local"
    test_targets:
    - "//..."
  windows_runfiles_enabled:
    name: windows_runfiles_enabled
    platform: windows
    test_flags:
    - "--test_tag_filters=requires-runfiles,-fix-windows,-no-bazelci-windows"
    - "--enable_runfiles"
    test_targets:
    - "//..."
  rbe_ubuntu1604:
    name: rbe_ubuntu1604
    platform: rbe_ubuntu1604
    build_targets:
    - "//..."
    build_flags:
    # TODO(gregmagolan): figure out how to install missing shared libs
    # Without this filter the @cypress external repository will be built and that build will fail due to missing shared libs.
    - "--build_tag_filters=-no-rbe,-browser:chromium-local,-browser:firefox-local"
    test_flags:
    # TODO(gregmagolan): figure out how to install missing shared libs
    - "--test_tag_filters=-no-rbe,-browser:chromium-local,-browser:firefox-local"
    test_targets:
    - "//..."
